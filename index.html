<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>lovestring</title>
<style>
body { background:#0a0f1a; color:#e0e6ff; font-family:Poppins,sans-serif; margin:0; padding:10px;}
h1{text-align:center; color:#4ea1ff;}
.cardFlyer{background:#121b2c; border-radius:12px; padding:12px; margin-bottom:10px; box-shadow:0 2px 6px rgba(0,0,0,0.4);}
.cardFlyer img, .cardFlyer video, .cardFlyer audio{max-width:100%; border-radius:10px; margin-top:8px; cursor:pointer;}
button{background:#0044cc; color:white; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;}
button:hover{background:#0059ff;}
.like-btn{cursor:pointer; color:#ff4d6d; font-weight:bold; margin-right:8px;}
#popup, #popupNum{display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:100;}
.popup-content{background:#1a2438; border-radius:15px; padding:20px; text-align:center; max-width:320px;}
#publishArea{display:none; flex-direction:column; gap:8px; margin-bottom:15px; background:#11192a; padding:10px; border-radius:12px;}
input, textarea{width:100%; background:#0f1626; color:white; border:1px solid #2a3b57; border-radius:8px; padding:8px;}
#profilePic{display:block; margin:0 auto 10px; max-width:150px; border-radius:50%;}
.price {color:#10b981; font-weight:bold; margin-left:8px;}
</style>
</head>
<body>

<h1>üíã lovestring ‚ù§Ô∏è‚Äçüî•</h1>
<img id="profilePic" src="https://raw.githubusercontent.com/Lfg237/images-Lesfacilitateurs-/f1dc4576c317909de024794c0b29d5adcab556cf/20250830_035314.jpg" alt="Photo de profil">
agence de rencontres discr√®tes s√©rieuses 100% fiable mise en contact payante
<button onclick="window.open('https://lesfacilitateurs.vercel.app/index.html', '_blank')">Accueil</button>

<div id="adminCodeArea">
  <label>üîê Code admin :</label>
  <input type="password" id="adminCodeInput" placeholder="Code admin...">
  <button onclick="checkAdminCode()">Valider</button>
</div>

<div id="publishArea">
  <textarea id="newPostText" placeholder="√âcrire un post..."></textarea>
  <input type="text" id="numeroPayant" placeholder="Num√©ro payant (ex: 676353859)">
  <input type="number" id="numeroPrice" placeholder="Prix num√©ro payant (FCFA)">
  <input type="number" id="mediaPrice" placeholder="Prix m√©dia (FCFA)">
  <input type="file" id="mediaInput" accept="image/*,video/*,audio/*">
  <button id="btnPublish">Publier</button>
</div>

<div id="postsContainer"></div>

<!-- Popup g√©n√©ral paiement / m√©dias -->
<div id="popup" class="popup">
  <div class="popup-content">
    <h3>üí∞ Paiement requis</h3>
    <p id="popupText"></p>
    <textarea id="transactionMsg" rows="4" placeholder="Colle ici ton message de transaction ou code admin"></textarea>
    <button onclick="validerPaiement()">‚úÖ Valider</button>
    <button onclick="fermerPopup()">‚ùå Annuler</button>
  </div>
</div>

<!-- Popup num√©ro -->
<div id="popupNum" class="popup">
  <div class="popup-content">
    <h3>üìû Num√©ro d√©bloqu√©</h3>
    <p id="popupNumText"></p>
    <button onclick="fermerPopupNum()">‚ùå Fermer</button>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://nqqlsntgmorujffrntih.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xcWxzbnRnbW9ydWpmZnJudGloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NzE5OTQsImV4cCI6MjA3NTE0Nzk5NH0.d77RSXyoK-2rFvxAiJB4xgSYpXEHsTKCdF0A3RwzXwY'
const supabase = createClient(supabaseUrl, supabaseKey)

let currentUser = 'User-' + crypto.randomUUID().slice(0,8)
let isAdmin = false
let currentAction = {type:'', postId:null}

const adminCodeInput = document.getElementById('adminCodeInput')
const publishArea = document.getElementById('publishArea')
const postsContainer = document.getElementById('postsContainer')
const mediaInput = document.getElementById('mediaInput')
const numeroInput = document.getElementById('numeroPayant')
const numeroPriceInput = document.getElementById('numeroPrice')
const mediaPriceInput = document.getElementById('mediaPrice')

// Admin check
window.checkAdminCode = function() {
  if(adminCodeInput.value.trim()==='233233'){
    isAdmin = true
    alert('‚úÖ Acc√®s administrateur activ√© !')
    publishArea.style.display='flex'
    adminCodeInput.parentElement.style.display='none'
    loadPosts()
  } else alert('‚ùå Code incorrect')
}

// Publish post
document.getElementById('btnPublish').onclick = async () => {
  if(!isAdmin) return alert('Seul l‚Äôadmin peut publier.')
  const text = document.getElementById('newPostText').value.trim()
  const numero = numeroInput.value.trim()
  const numeroPrice = parseInt(numeroPriceInput.value) || 0
  const mediaPrice = parseInt(mediaPriceInput.value) || 0
  if(!text && !mediaInput.files[0]) return alert('Rien √† publier.')

  let mediaUrl = null
  if(mediaInput.files[0]){
    const file = mediaInput.files[0]
    const fileName = `${Date.now()}_${file.name}`
    const { error:uploadError } = await supabase.storage.from('media').upload(fileName, file)
    if(uploadError) return alert('Erreur upload m√©dia: ' + uploadError.message)
    const { data:urlData } = supabase.storage.from('media').getPublicUrl(fileName)
    mediaUrl = urlData.publicUrl
  }

  const { error } = await supabase.from('posts').insert([{
    id: crypto.randomUUID(),
    user_id: currentUser,
    text: text,
    media_url: mediaUrl,
    media_comment: text,
    numero_payant: numero || '',
    numero_price: numeroPrice,
    media_price: mediaPrice,
    likes:0,
    liked_by: JSON.stringify([]),
    created_at: new Date().toISOString()
  }])
  if(error) return alert('Erreur cr√©ation post')
  document.getElementById('newPostText').value=''
  mediaInput.value=''
  numeroInput.value=''
  numeroPriceInput.value=''
  mediaPriceInput.value=''
  loadPosts()
}

// Load posts
async function loadPosts(){
  postsContainer.innerHTML=''
  const { data: posts } = await supabase.from('posts').select().order('created_at',{ascending:false})
  if(!posts || posts.length===0){postsContainer.innerHTML='<i>Aucun post disponible</i>'; return;}
  
  posts.forEach(async post=>{
    // V√©rifier si l'utilisateur a pay√©
    const { data: payment } = await supabase.from('validated_payments')
      .select().eq('post_id', post.id).eq('user_id', currentUser).maybeSingle()
    const hasPaid = payment!==null || isAdmin

    // M√©dia affich√© normalement
    let mediaHTML = ''
    if(post.media_url){
      const type = post.media_url.split('.').pop().toLowerCase()
      if(type==='mp4'){
        mediaHTML = `<video src="${post.media_url}" style="max-width:100%; border-radius:10px; margin-top:8px; cursor:pointer;" ${hasPaid?'controls':''} onclick="!${hasPaid}?demanderPaiement('media','${post.id}'):null"></video>`
      } else if(type==='mp3' || type==='wav'){
        mediaHTML = `<audio src="${post.media_url}" style="width:100%;" ${hasPaid?'controls':''} onclick="!${hasPaid}?demanderPaiement('media','${post.id}'):null"></audio>`
      } else {
        mediaHTML = `<img src="${post.media_url}" style="width:100%; cursor:pointer;" onclick="!${hasPaid}?demanderPaiement('media','${post.id}'):null">`
      }
    }

    const numeroHTML = post.numero_payant ? 
      (hasPaid ? `<span class="price">Num√©ro d√©bloqu√©</span>` 
       : `<span class="like-btn" onclick="demanderPaiement('numero','${post.id}')">üìû Voir num√©ro</span> <span class="price">${post.numero_price} FCFA</span>`) : ''

    const card = document.createElement('div')
    card.className='cardFlyer'
    card.innerHTML=`
      <b>Commentaire:</b> ${post.media_comment || ''}<br>
      ${mediaHTML}
      <div style="margin-top:6px;">
        ${numeroHTML}
        ${isAdmin?`<button onclick="modifierPost('${post.id}')">‚úèÔ∏è Modifier</button>`:''}
        ${isAdmin?`<button onclick="deletePost('${post.id}')">üóëÔ∏è Supprimer</button>`:''}
      </div>
      <small>${new Date(post.created_at).toLocaleString()}</small>
    `
    postsContainer.appendChild(card)
  })
}

// Popup paiement g√©n√©ral
function showPopupMedia(post){
  const beneficiaries=[
    {name:'Loveline Wirnkar', numero:'676353859'},
    {name:'Bibi OM', numero:'656523656'}
  ]
  let text = `üí∞ Paiement requis\nM√©dia ou num√©ro payant\nB√©n√©ficiaires :\n`
  beneficiaries.forEach(b=> text+=`‚Ä¢ ${b.name} : ${b.numero}\n`)
  document.getElementById('popupText').innerText=text
  document.getElementById('transactionMsg').value=''
  document.getElementById('popup').style.display='flex'
}

// Validation paiement
window.validerPaiement = async function(){
  const msg = document.getElementById('transactionMsg').value.trim().toLowerCase()
  if(!msg) return alert('‚ö†Ô∏è Message requis ou code admin')

  const { data: post } = await supabase.from('posts').select().eq('id', currentAction.postId).single()
  if(!post) return

  // Admin d√©bloque tout
  if(msg==='233233'){
    alert('‚úÖ Acc√®s admin valid√© ! Contenu d√©bloqu√©.')
    if(currentAction.type==='numero') showNumeroPopup(post.numero_payant)
    fermerPopup()
    loadPosts()
    return
  }

  // Validation mobile money
  const beneficiaries=[
    {name:'loveline', numero:'676353859'},
    {name:'bibi', numero:'656523656'}
  ]
  let valid=false
  beneficiaries.forEach(b=>{ if(msg.includes(b.name) || msg.includes(b.numero)) valid=true })
  const { data: existing } = await supabase.from('validated_payments').select().eq('transaction_msg', msg).single()
  if(existing){ alert('‚ö†Ô∏è Transaction d√©j√† utilis√©e'); return }

  if(valid){
    await supabase.from('validated_payments').insert([{transaction_msg: msg, post_id: post.id, user_id: currentUser, created_at: new Date().toISOString()}])
    alert('‚úÖ Paiement valid√© !')
    if(currentAction.type==='numero') showNumeroPopup(post.numero_payant)
    fermerPopup()
    loadPosts()
  } else alert('‚ùå Paiement invalide !')
}

// Popup num√©ro
function showNumeroPopup(numero){
  document.getElementById('popupNumText').innerText = numero
  document.getElementById('popupNum').style.display='flex'
}
window.fermerPopup = function(){ document.getElementById('popup').style.display='none' }
window.fermerPopupNum = function(){ document.getElementById('popupNum').style.display='none' }

// Supprimer / modifier
window.deletePost = async function(postId){
  await supabase.from('posts').delete().eq('id',postId)
  loadPosts()
}
window.modifierPost = async function(postId){
  const { data: post } = await supabase.from('posts').select().eq('id', postId).single()
  if(!post) return

  // Modifier tout le post via prompts
  const newText = prompt("Modifier le commentaire:", post.media_comment)
  const newNumero = prompt("Modifier le num√©ro payant:", post.numero_payant)
  const newNumeroPrice = prompt("Modifier le prix du num√©ro (FCFA):", post.numero_price)
  const newMediaPrice = prompt("Modifier le prix du m√©dia (FCFA):", post.media_price)
  const newMediaUrl = prompt("Modifier le lien m√©dia (laisser vide si inchang√©):", post.media_url)

  if(newText!==null && newNumero!==null && newNumeroPrice!==null && newMediaPrice!==null && newMediaUrl!==null){
    await supabase.from('posts').update({
      media_comment: newText,
      numero_payant: newNumero,
      numero_price: parseInt(newNumeroPrice)||0,
      media_price: parseInt(newMediaPrice)||0,
      media_url: newMediaUrl
    }).eq('id', postId)

    loadPosts()
  }
}

// D√©clenche popup paiement
window.demanderPaiement = function(type, postId){
  currentAction={type,type,postId}
  showPopupMedia({media_price:0})
}

loadPosts()
</script>
</body>
</html>
